<!DOCTYPE html>
<html lang="th" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏ß‡∏ï</title>
  
  <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/IMG_602976b5b060daac652b.png" type="image/png">
  
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* === [ CSS ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì 100% ] === */
    :root {
      --primary-color: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #818cf8;
      --secondary-color: #8b5cf6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --bg-primary: #ffffff;
      --bg-secondary: #f9fafb;
      --bg-tertiary: #f3f4f6;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --text-tertiary: #9ca3af;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --transition: all 0.3s ease;
    }
    [data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-tertiary: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #d1d5db;
      --text-tertiary: #9ca3af;
      --border-color: #374151;
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Kanit', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: var(--transition);
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    .btn-primary { background-color: var(--primary-color); color: white; }
    .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px); box-shadow: var(--shadow-md); }
    .btn-secondary { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .btn-secondary:hover { background-color: var(--border-color); }
    .btn-danger { background-color: var(--danger-color); color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-success { background-color: var(--success-color); color: white; }
    .btn-warning { background-color: var(--warning-color); color: white; }
    .btn-block { width: 100%; justify-content: center; }
    
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-primary); font-size: 14px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%; padding: 12px; border: 1px solid var(--border-color);
      border-radius: var(--radius-md); font-size: 14px;
      background-color: var(--bg-primary); color: var(--text-primary);
      transition: var(--transition); font-family: 'Kanit', 'Inter', sans-serif;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* Checkbox Group ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô */
    .checkbox-group {
        display: flex; align-items: center; justify-content: space-between;
        padding: 15px; border: 1px solid var(--border-color);
        border-radius: var(--radius-md); background-color: var(--bg-primary);
        margin-bottom: 10px; transition: var(--transition);
    }
    .checkbox-group:hover { border-color: var(--primary-color); }
    .checkbox-group label { margin: 0; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 500; flex: 1; }
    .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }

    /* Modals & Utils */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.active { display: flex; }
    .modal-content { background-color: var(--bg-primary); border-radius: var(--radius-lg); width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-xl); animation: modalSlideIn 0.3s ease; }
    @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
    .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h2 { font-size: 20px; font-weight: 600; }
    .modal-close { background: none; border: none; font-size: 20px; color: var(--text-tertiary); cursor: pointer; padding: 5px; }
    .modal-content form { padding: 20px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; padding: 20px; }
    
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background-color: var(--bg-primary); padding: 16px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; min-width: 300px; animation: toastSlideIn 0.3s ease; }
    @keyframes toastSlideIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .toast.success { border-left: 4px solid var(--success-color); }
    .toast.error { border-left: 4px solid var(--danger-color); }
    .toast-content { flex: 1; }
    
    .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center; }
    .loading-overlay.active { display: flex; }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display: none !important; }

    /* Dashboard Layout */
    .dashboard-container { display: flex; height: 100vh; overflow: hidden; }
    .sidebar { width: 260px; background-color: var(--bg-primary); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: var(--transition); z-index: 100; }
    .sidebar.collapsed { width: 70px; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 12px; font-size: 20px; font-weight: 700; color: var(--primary-color); }
    .logo img { height: 28px; width: 28px; }
    .sidebar.collapsed .logo span { display: none; }
    .sidebar-toggle { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: var(--radius-sm); }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 20px 0; }
    .sidebar-nav ul { list-style: none; }
    .sidebar-nav li { margin-bottom: 5px; }
    .sidebar-nav a { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: var(--text-secondary); text-decoration: none; transition: var(--transition); border-left: 3px solid transparent; }
    .sidebar-nav a:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
    .sidebar-nav li.active a { background-color: rgba(99, 102, 241, 0.1); color: var(--primary-color); border-left-color: var(--primary-color); }
    .sidebar-nav i { font-size: 18px; width: 20px; }
    .sidebar.collapsed .sidebar-nav span { display: none; }
    .sidebar-footer { padding: 20px; border-top: 1px solid var(--border-color); }
    .user-profile { display: flex; align-items: center; gap: 12px; }
    .user-profile i { width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-tertiary); color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .user-info { display: flex; flex-direction: column; }
    .user-name { font-weight: 600; font-size: 14px; }
    .user-role { font-size: 12px; color: var(--text-tertiary); }
    .sidebar.collapsed .user-info { display: none; }
    
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .navbar { height: 70px; background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    .navbar-left, .navbar-right { display: flex; align-items: center; gap: 20px; }
    .mobile-toggle { display: none; background: none; border: none; font-size: 20px; color: var(--text-primary); cursor: pointer; }
    .theme-toggle, .notifications { background: none; border: none; font-size: 20px; color: var(--text-secondary); cursor: pointer; padding: 8px; border-radius: var(--radius-md); }
    .user-menu { position: relative; }
    .user-menu .user-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; background-color: var(--bg-tertiary); color: var(--primary-color); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .dropdown-menu { display: none; position: absolute; top: calc(100% + 10px); right: 0; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 200px; z-index: 10000; }
    .dropdown-menu.active { display: block; }
    .dropdown-menu a { display: flex; align-items: center; gap: 12px; padding: 12px 16px; color: var(--text-primary); text-decoration: none; }
    
    .content { flex: 1; overflow-y: auto; padding: 30px; background-color: var(--bg-secondary); }
    .page { display: none; } .page.active { display: block; animation: pageFadeIn 0.5s ease; }
    @keyframes pageFadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .page-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
    .page-header h1 { font-size: 32px; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background-color: var(--bg-primary); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); display: flex; gap: 16px; }
    .stat-icon { width: 60px; height: 60px; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
    .stat-icon.green { background: var(--success-color); } .stat-icon.purple { background: var(--secondary-color); }
    .stat-value { font-size: 28px; font-weight: 700; }
    
    .settings-section { background-color: var(--bg-primary); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); margin-bottom: 20px; }
    .settings-section h3 { font-size: 18px; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    .table-container { background-color: var(--bg-primary); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); overflow: hidden; max-height: 500px; overflow-y: auto; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { padding: 16px; text-align: left; font-weight: 600; background-color: var(--bg-tertiary); position: sticky; top: 0; }
    .data-table td { padding: 16px; border-top: 1px solid var(--border-color); vertical-align: middle; }
    .table-actions-cell { display: flex; gap: 8px; }
    .action-btn { background: none; border: none; padding: 8px; cursor: pointer; color: var(--text-secondary); }
    .action-btn:hover { color: var(--text-primary); }
    
    .chart-card { background-color: var(--bg-primary); padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); height: 400px; margin-bottom: 30px; }
    .tab-controls { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid var(--border-color); }
    .tab-btn { padding: 12px 20px; background: none; border: none; cursor: pointer; font-size: 16px; font-weight: 500; color: var(--text-secondary); border-bottom: 3px solid transparent; }
    .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    
    .admin-table-image img { width: 60px; height: auto; border-radius: 5px; border: 1px solid var(--border-color); }
    
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -260px; height: 100vh; z-index: 1000; } .sidebar.active { left: 0; }
      .mobile-toggle { display: block; } .navbar { padding: 0 16px; } .content { padding: 16px; }
      .stats-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  
  <div class="dashboard-container" id="main-dashboard" style="display: flex;"> <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <img src="https://img5.pic.in.th/file/secure-sv1/IMG_60290ec6a71fd92a13d0.png" alt="Logo" id="sidebar-logo">
          <span>Admin Panel</span>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <nav class="sidebar-nav">
        <ul>
          <li class="active"><a href="#dashboard" data-page="dashboard"><i class="fas fa-home"></i> <span>Dashboard</span></a></li>
          <li><a href="#products" data-page="products"><i class="fas fa-tshirt"></i> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠</span></a></li>
          <li><a href="#users" data-page="users"><i class="fas fa-users"></i> <span>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÇ‡∏´‡∏ß‡∏ï</span></a></li>
          <li><a href="#settings" data-page="settings"><i class="fas fa-cog"></i> <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</span></a></li>
          <li><a href="#notifications" data-page="notifications"><i class="fas fa-bell"></i> <span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</span></a></li>
          <li><a href="#accounts" data-page="accounts"><i class="fas fa-user-shield"></i> <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span></a></li>
          <li><a href="#tools" data-page="tools"><i class="fas fa-tools"></i> <span>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠</span></a></li>
          <li><a href="#logs" data-page="logs"><i class="fas fa-history"></i> <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span></a></li>
        </ul>
      </nav>

      <div class="sidebar-footer">
        <div class="user-profile">
          <i class="fas fa-user-shield"></i>
          <div class="user-info">
            <span class="user-name" id="admin-profile-name">Admin</span>
            <span class="user-role">Administrator</span>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <header class="navbar">
        <div class="navbar-left">
          <button class="mobile-toggle" id="mobileToggle">
            <i class="fas fa-bars"></i>
          </button>
          <button class="btn btn-secondary" id="refreshDataButton">
              <i class="fas fa-sync-alt"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>

        <div class="navbar-right">
          <button class="theme-toggle" id="themeToggle">
            <i class="fas fa-moon"></i>
          </button>

          <div class="user-menu">
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="dropdown-menu" id="userDropdown">
              <a href="#settings" data-page="settings"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</a>
              <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </div>
          </div>
        </div>
      </header>

      <div class="content" id="pageContent">
        
        <div class="page active" id="dashboard-page">
          <div class="page-header">
            <div><h1 id="welcome-message">Dashboard</h1><p>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</p></div>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon green"><i class="fas fa-user-check"></i></div>
              <div class="stat-content"><h3>‡∏ú‡∏π‡πâ‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="stat-value" id="stat-total-voters">0</p></div>
            </div>
            <div class="stat-card">
              <div class="stat-icon purple"><i class="fas fa-vote-yea"></i></div>
              <div class="stat-content"><h3>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3><p class="stat-value" id="stat-total-votes">0</p></div>
            </div>
          </div>
          <div class="settings-section">
            <h3><i class="fas fa-chart-pie"></i> Dashboard ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
            <div id="dashboard-summary"><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ...</p></div>
          </div>
        </div>

        <div class="page" id="products-page">
          <div class="page-header">
            <h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠</h1>
            <button class="btn btn-primary" id="addDesignBtn"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡πÉ‡∏´‡∏°‡πà</button>
          </div>
          <div class="settings-section">
            <h3><i class="fas fa-poll"></i> ‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏ï‡∏≤‡∏£‡∏≤‡∏á)</h3>
            <div class="table-container">
                <table class="data-table" id="adminVoteResultsTable"><thead><tr><th>Design ID</th><th>Design Name</th><th>Vote Count</th><th>Image</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
          <div class="charts-grid">
            <div class="chart-card">
              <div class="chart-header"><h3><i class="fas fa-chart-bar"></i> ‡∏Å‡∏£‡∏≤‡∏ü‡∏ú‡∏•‡πÇ‡∏´‡∏ß‡∏ï</h3></div>
              <canvas id="voteChart"></canvas>
            </div>
          </div>
        </div>

        <div class="page" id="users-page">
          <div class="page-header">
            <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1> 
            <div class="btn-group"><button class="btn btn-primary" id="exportUsersPdfButton"><i class="fas fa-file-pdf"></i> ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (.pdf)</button></div>
          </div>
          <div class="tab-controls" id="userTabs">
            <button class="tab-btn active" data-status="voted"><i class="fas fa-user-check"></i> ‡πÇ‡∏´‡∏ß‡∏ï‡πÅ‡∏•‡πâ‡∏ß (<span id="voted-count">0</span>)</button>
            <button class="tab-btn" data-status="unvoted"><i class="fas fa-user-clock"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏ß‡∏ï (<span id="unvoted-count">0</span>)</button>
          </div>
          <div class="table-controls">
            <div class="search-filter">
              <select id="gradeFilter"><option value="all">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)</option><option value="‡∏°.1">‡∏°.1</option><option value="‡∏°.2">‡∏°.2</option><option value="‡∏°.3">‡∏°.3</option><option value="‡∏°.4">‡∏°.4</option><option value="‡∏°.5">‡∏°.5</option><option value="‡∏°.6">‡∏°.6</option></select>
              <input type="text" id="userSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô/‡∏ä‡∏∑‡πà‡∏≠...">
            </div>
          </div>
          <div class="table-container">
            <table class="data-table" id="adminUsersTable"><thead><tr><th>Student ID</th><th>Full Name</th><th>Grade</th><th>Room</th><th class="voted-col">Timestamp</th><th class="voted-col">Vote Choice</th><th class="voted-col">Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div class="page" id="settings-page">
          <div class="page-header"><h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h1></div>
          <div class="settings-container">
            <div class="settings-section">
                <h3><i class="fas fa-clock"></i> ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h3>
                <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô:</label><input type="datetime-local" id="voteStartTime"></div>
                <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î:</label><input type="datetime-local" id="voteEndTime"></div>
                <p id="current-vote-time" style="font-weight: bold; margin-top: 15px; color: var(--text-secondary);"></p>
                <div class="btn-group"><button class="btn btn-primary" id="setVoteTimeButton">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÇ‡∏´‡∏ß‡∏ï</button><button class="btn btn-danger" id="closeVotingNowButton">‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</button></div>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-bullhorn"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</h3>
                <div class="form-group"><textarea id="announcementText" rows="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô üì£ ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ 16:00 ‡∏ô. ‡∏ô‡∏µ‡πâ!"></textarea></div>
                <div class="btn-group"><button class="btn btn-primary" id="saveAnnouncementButton">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®</button></div>
            </div>
            <div class="settings-section" style="border: 2px solid var(--primary-light);">
                <h3><i class="fas fa-book"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
                <div class="form-group"><textarea id="helpContentEditor" rows="8" style="font-family: monospace; background-color: var(--bg-tertiary);" placeholder="<div class='faq-item'>...</div>"></textarea></div>
                <div class="btn-group"><button class="btn btn-primary" id="saveHelpButton"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</button></div>
            </div>
          </div>
        </div>

        <div class="page" id="notifications-page">
            <div class="page-header"><h1>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h1></div>
            <div class="settings-container">
                <div class="settings-section">
                    <h3><i class="fas fa-bell"></i> ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <div class="checkbox-group"><label for="notifNewVote"><i class="fas fa-vote-yea"></i> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï‡πÉ‡∏´‡∏°‡πà</label><input type="checkbox" id="notifNewVote"></div>
                    <div class="checkbox-group"><label for="notifPwChange"><i class="fas fa-key"></i> ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label><input type="checkbox" id="notifPwChange"></div>
                </div>
                <div class="settings-section">
                    <h3><i class="fas fa-user-tag"></i> ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                    <div class="checkbox-group"><label for="targetAdmin"><i class="fas fa-user-shield"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</label><input type="checkbox" id="targetAdmin"></div>
                    <div class="checkbox-group"><label for="targetUser"><i class="fas fa-user"></i> ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label><input type="checkbox" id="targetUser"></div>
                    <div class="btn-group"><button class="btn btn-primary" id="saveNotifButton"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button></div>
                </div>
            </div>
        </div>
        
        <div class="page" id="accounts-page">
          <div class="page-header"><h1>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h1></div>
          <div class="settings-container">
            <div class="settings-section">
                <h3><i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h3>
                <div class="form-group"><input type="text" id="newAdminUsername" placeholder="username" required></div>
                <div class="form-group"><input type="password" id="newAdminPassword" placeholder="password" required></div>
                <div class="form-group"><input type="text" id="newAdminFullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required></div>
                <button class="btn btn-primary" id="addAdminButton">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</button>
                <h3 style="margin-top: 30px;">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</h3>
                <div class="table-container"><table class="data-table" id="adminAccountsTable"><thead><tr><th>Username</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
            </div>
          </div>
        </div>

        <div class="page" id="tools-page">
          <div class="page-header"><h1>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h1></div>
          <div class="settings-container">
             <div class="settings-section">
                <h3><i class="fas fa-tools"></i> ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <div class="btn-group">
                    <button id="recalculateVotesButton" class="btn btn-primary" style="background-color: var(--warning-color); color: white;"><i class="fas fa-calculator"></i> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
                    <button id="resetVotesButton" class="btn btn-danger"><i class="fas fa-history"></i> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    <button id="clearUsersButton" class="btn btn-danger"><i class="fas fa-user-times"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</button>
                </div>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-user-edit"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏´‡∏£‡∏∑‡∏≠ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <form id="student-form">
                    <div class="form-group"><input type="text" id="manualStudentId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" required maxlength="5"></div>
                    <div class="form-group"><input type="text" id="manualFullName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" required></div>
                    <div class="form-group"><select id="manualGrade"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô --</option><option value="‡∏°.1">‡∏°.1</option><option value="‡∏°.2">‡∏°.2</option><option value="‡∏°.3">‡∏°.3</option><option value="‡∏°.4">‡∏°.4</option><option value="‡∏°.5">‡∏°.5</option><option value="‡∏°.6">‡∏°.6</option></select></div>
                    <div class="form-group"><select id="manualRoom"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div>
                    <div class="btn-group"><button type="submit" class="btn btn-primary" id="saveStudentButton"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button></div>
                </form>
            </div>
            <div class="settings-section">
                <h3><i class="fas fa-file-csv"></i> Import ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (CSV)</h3>
                <div class="form-group"><input type="file" id="csvFile" accept=".csv" style="padding: 10px; background-color: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color); width: 100%;"></div>
                <div class="btn-group"><button class="btn btn-primary" id="uploadCsvButton" style="background-color: var(--success-color);"><i class="fas fa-upload"></i> Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CSV)</button></div>
            </div>
          </div>
        </div>
        
        <div class="page" id="logs-page">
          <div class="page-header"><h1>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Audit Log)</h1></div>
          <div class="settings-section">
            <div class="table-container"><table class="data-table" id="adminLogsTable"><thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>Username</th><th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead><tbody></tbody></table></div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <div class="modal" id="designModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="designModalTitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠</h2><button class="modal-close" data-modal="designModal"><i class="fas fa-times"></i></button></div>
      <form id="designForm">
        <input type="hidden" id="editMode" value="false"><input type="hidden" id="editDesignIdHidden">
        <div class="form-group"><label for="designIdInput">Design ID:</label><input type="text" id="designIdInput" required></div>
        <div class="form-group"><label for="designNameInput">‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏ö‡πÄ‡∏™‡∏∑‡πâ‡∏≠:</label><input type="text" id="designNameInput" required></div>
        <div class="form-group"><label for="designImageUrlInput">URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label><input type="text" id="designImageUrlInput"></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-modal="designModal">Cancel</button><button type="submit" class="btn btn-primary" id="saveDesignButton">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
      </form>
    </div>
  </div>

  <div class="modal" id="editVoteModal">
    <div class="modal-content">
      <div class="modal-header"><h2 id="editVoteModalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏ß‡∏ï</h2><button class="modal-close" data-modal="editVoteModal"><i class="fas fa-times"></i></button></div>
      <form id="editVoteForm">
        <input type="hidden" id="editVoteStudentId"><input type="hidden" id="editVoteOldChoice">
        <div class="form-group"><label>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</label><input type="text" id="editVoteStudentInfo" readonly style="background-color: var(--bg-tertiary);"></div>
        <div class="form-group"><label for="newVoteChoiceSelect">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏ß‡∏ï:</label><select id="newVoteChoiceSelect" required></select></div>
        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-modal="editVoteModal">Cancel</button><button type="submit" class="btn btn-primary" id="saveVoteButton">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button></div>
      </form>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>
  <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>

  <script>
    // ‚ö†Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwwJzP_jTHieO4asdyGAJk1hYHxP5gYSIZu2XNp_myLqtAqxmMMsekofM4Xl3GguKlvCQ/exec';
    
    // ‚≠êÔ∏è 1. ‡πÄ‡∏ä‡πá‡∏Ñ Session (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Admin ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏î‡πÑ‡∏õ Login)
    if (!sessionStorage.getItem('adminUser')) {
        window.top.location.href = WEB_APP_URL + '?page=login';
    }
    let currentAdminUser = sessionStorage.getItem('adminUser');

    // --- Global Variables ---
    let allStudentsData = [];
    let allVoteDesigns = [];
    let currentUserView = 'voted';

    // --- Utils ---
    function showToast(message, type = 'info', title = '') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div'); toast.className = `toast ${type}`;
      toast.innerHTML = `<i></i><div class="toast-content">${message}</div>`;
      container.appendChild(toast); setTimeout(() => toast.remove(), 3000);
    }
    function showLoading() { document.getElementById('loadingOverlay').classList.add('active'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.remove('active'); }
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    
    // ‚≠êÔ∏è Timezone Fix
    function toLocalISOString(dateString) {
        try {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '';
            const offsetMs = date.getTimezoneOffset() * 60 * 1000;
            const msLocal = date.getTime() - offsetMs;
            return new Date(msLocal).toISOString().slice(0, 16);
        } catch (e) { return ''; }
    }

    async function callApi(action, data = {}) {
        if (currentAdminUser) data.username = currentAdminUser;
        try {
            const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
            return await response.json();
        } catch (e) { return { status: 'error', message: e.message }; }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Setup Sidebar
        document.getElementById('sidebarToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('collapsed'));
        document.getElementById('mobileToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            sessionStorage.clear();
            window.top.location.href = WEB_APP_URL + '?page=login';
        });

        // Nav & Modals
        document.querySelectorAll('[data-page]').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                navigateToPage(link.getAttribute('data-page'));
            });
        });
        document.querySelectorAll('[data-modal]').forEach(btn => {
            btn.addEventListener('click', () => closeModal(btn.getAttribute('data-modal')));
        });
        document.querySelectorAll('.modal-close, .modal-footer .btn-secondary').forEach(btn => {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                if(modal) modal.classList.remove('active');
            });
        });

        // Settings Buttons
        document.getElementById('setVoteTimeButton').addEventListener('click', async () => {
            showLoading();
            await callApi('updateVoteTime', {
                startTime: document.getElementById('voteStartTime').value,
                endTime: document.getElementById('voteEndTime').value
            });
            hideLoading();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            loadSettings();
        });

        document.getElementById('saveAnnouncementButton').addEventListener('click', async () => {
            showLoading();
            await callApi('updateAnnouncementText', { text: document.getElementById('announcementText').value });
            hideLoading();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÅ‡∏•‡πâ‡∏ß', 'success');
        });

        document.getElementById('saveHelpButton').addEventListener('click', async () => {
            showLoading();
            await callApi('updateHelpContent', { htmlContent: document.getElementById('helpContentEditor').value });
            hideLoading();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
        });
        
        document.getElementById('saveNotifButton').addEventListener('click', async () => {
            const s = {
                NOTIF_STATUS_NEW_VOTE: document.getElementById('notifNewVote').checked,
                NOTIF_STATUS_PW_CHANGE: document.getElementById('notifPwChange').checked,
                NOTIF_TARGET_ADMIN: document.getElementById('targetAdmin').checked,
                NOTIF_TARGET_USER: document.getElementById('targetUser').checked
            };
            showLoading();
            const res = await callApi('updateNotifSettings', { settings: s });
            hideLoading();
            showToast(res.message, res.status);
        });

        // Forms
        document.getElementById('designForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const isEdit = document.getElementById('editMode').value === 'true';
            const id = isEdit ? document.getElementById('editDesignIdHidden').value : document.getElementById('designIdInput').value;
            showLoading();
            const action = isEdit ? 'editDesign' : 'addDesign';
            await callApi(action, { 
                designId: id, 
                designName: document.getElementById('designNameInput').value, 
                imageUrl: document.getElementById('designImageUrlInput').value 
            });
            hideLoading();
            closeModal('designModal');
            loadProducts();
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        });

        document.getElementById('editVoteForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editVoteStudentId').value;
            const oldC = document.getElementById('editVoteOldChoice').value;
            const newC = document.getElementById('newVoteChoiceSelect').value;
            if(oldC === newC) return alert('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°');
            showLoading();
            await callApi('adminUpdateVote', { studentId: id, oldVoteChoice: oldC, newVoteChoice: newC });
            hideLoading();
            closeModal('editVoteModal');
            loadUsers();
            showToast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß', 'success');
        });
        
        // Other Action Buttons
        document.getElementById('refreshDataButton').addEventListener('click', loadAllAdminData);
        document.getElementById('closeVotingNowButton').addEventListener('click', async()=>{ if(confirm('‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏ß‡∏ï?')) { await callApi('closeVotingNow'); loadSettings(); } });
        document.getElementById('addAdminButton').addEventListener('click', async()=>{ await callApi('addAdminAccount', {usernameToAdd:document.getElementById('newAdminUsername').value, passwordToAdd:document.getElementById('newAdminPassword').value, fullNameToAdd:document.getElementById('newAdminFullName').value}); loadAccounts(); });
        document.getElementById('saveStudentButton').addEventListener('click', async(e)=>{ e.preventDefault(); await callApi('addOrUpdateStudent', {studentId:document.getElementById('manualStudentId').value, password:document.getElementById('manualPassword').value, fullName:document.getElementById('manualFullName').value, grade:document.getElementById('manualGrade').value, room:document.getElementById('manualRoom').value}); showToast('Saved'); });
        
        // Load Initial Data
        document.getElementById('admin-profile-name').textContent = currentAdminUser;
        loadAllAdminData();
    });

    function navigateToPage(pageName) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(`${pageName}-page`).classList.add('active');
        document.querySelectorAll('.sidebar-nav li').forEach(l => l.classList.remove('active'));
        const link = document.querySelector(`a[data-page="${pageName}"]`);
        if (link) link.parentElement.classList.add('active');

        if(pageName === 'dashboard') loadDashboardData();
        else if(pageName === 'products') loadAdminData();
        else if(pageName === 'users') loadAdminData().then(filterAndSearchUsers);
        else if(pageName === 'settings') loadSettings();
        else if(pageName === 'notifications') loadNotificationSettings();
        else if(pageName === 'accounts') loadAccounts();
        else if(pageName === 'logs') loadLogs();
    }

    async function loadAllAdminData() { await loadDashboardData(); await loadAdminData(); }

    async function loadDashboardData() {
        const res = await callApi('getAdminDashboardData');
        if(res.status === 'success') {
            document.getElementById('stat-total-voters').textContent = res.totalVoters;
            document.getElementById('stat-total-votes').textContent = res.totalVotes;
            let html = '<ul>'; for(const g in res.votesByGradeAndRoom) html += `<li>${g}: ${res.votesByGradeAndRoom[g].total} ‡∏Ñ‡∏ô</li>`; html += '</ul>';
            document.getElementById('dashboard-summary').innerHTML = html;
        }
    }

    async function loadAdminData() {
        const res = await callApi('getAdminData');
        if(res.status === 'success') {
            allVoteDesigns = res.votes; 
            document.querySelector('#adminVoteResultsTable tbody').innerHTML = res.votes.map(v => `<tr><td>${v[0]}</td><td>${v[1]}</td><td>${v[2]}</td><td><img src="${v[3]}" class="admin-table-image"></td><td><button class="action-btn edit" onclick="promptEditDesign('${v[0]}','${v[1]}','${v[3]}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete" onclick="deleteDesign('${v[0]}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
            displayVoteChart(res.votes);
            allStudentsData = res.allStudents;
            filterAndSearchUsers();
        }
    }

    async function loadSettings() {
        const t = await callApi('getVoteTime');
        if (t.startTime) document.getElementById('voteStartTime').value = toLocalISOString(t.startTime);
        if (t.endTime) document.getElementById('voteEndTime').value = toLocalISOString(t.endTime);
        if(t.startTime) document.getElementById('current-vote-time').innerText = `‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£: ${new Date(t.startTime).toLocaleString()} - ${new Date(t.endTime).toLocaleString()}`;
        
        const a = await callApi('getAnnouncementText');
        document.getElementById('announcementText').value = a.text || '';
        const h = await callApi('getHelpContent');
        document.getElementById('helpContentEditor').value = h.htmlContent || '';
    }
    
    async function loadNotificationSettings() {
        const r = await callApi('getNotifSettings');
        if(r.status==='success' && r.settings) {
            document.getElementById('notifNewVote').checked = r.settings.NOTIF_STATUS_NEW_VOTE;
            document.getElementById('notifPwChange').checked = r.settings.NOTIF_STATUS_PW_CHANGE;
            document.getElementById('targetAdmin').checked = r.settings.NOTIF_TARGET_ADMIN;
            document.getElementById('targetUser').checked = r.settings.NOTIF_TARGET_USER;
        }
    }

    async function loadAccounts() {
        const r = await callApi('getAdminAccounts');
        document.querySelector('#adminAccountsTable tbody').innerHTML = r.accounts.map(a => `<tr><td>${a[0]}</td><td>${a[2]}</td><td><button class="action-btn delete" onclick="deleteAdmin('${a[0]}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
    }
    
    async function loadLogs() {
        const r = await callApi('getAdminLogs');
        document.querySelector('#adminLogsTable tbody').innerHTML = r.logs.map(l => `<tr><td>${new Date(l[0]).toLocaleString()}</td><td>${l[1]}</td><td>${l[2]}</td><td>${l[3]}</td></tr>`).join('');
    }

    function filterAndSearchUsers() {
        const g = document.getElementById('gradeFilter').value;
        const t = document.getElementById('userSearchInput').value.toLowerCase();
        const isV = currentUserView === 'voted';
        const f = allStudentsData.filter(u => (u[6]===isV) && (g==='all'||u[2]===g) && (u[0].toString().includes(t)||u[1].toLowerCase().includes(t)));
        document.querySelector('#adminUsersTable tbody').innerHTML = f.map(u => `<tr><td>${u[0]}</td><td>${u[1]}</td><td>${u[2]}</td><td>${u[3]}</td><td class="voted-col">${u[4]||'-'}</td><td class="voted-col">${u[5]||'-'}</td><td class="voted-col"><button class="action-btn edit" onclick="promptEditVote('${u[0]}','${u[5]}','${u[1]}')"><i class="fas fa-edit"></i></button> <button class="action-btn delete" onclick="deleteUser('${u[0]}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');
        document.querySelectorAll('.voted-col').forEach(c => c.style.display = isV?'':'none');
    }

    // Global Actions
    window.promptAddDesign = () => { document.getElementById('designForm').reset(); document.getElementById('editMode').value = 'false'; document.getElementById('designIdInput').disabled = false; openModal('designModal'); };
    window.promptEditDesign = (id, n, img) => { document.getElementById('editMode').value = 'true'; document.getElementById('editDesignIdHidden').value = id; document.getElementById('designIdInput').value = id; document.getElementById('designIdInput').disabled = true; document.getElementById('designNameInput').value = n; document.getElementById('designImageUrlInput').value = img; openModal('designModal'); };
    window.promptEditVote = (id, oldC, name) => { document.getElementById('editVoteStudentId').value = id; document.getElementById('editVoteOldChoice').value = oldC; document.getElementById('editVoteStudentInfo').value = `${id} - ${name}`; const s = document.getElementById('newVoteChoiceSelect'); s.innerHTML = ''; allVoteDesigns.forEach(d => { const o = document.createElement('option'); o.value = d[0]; o.text = d[1]; if (d[0] == oldC) o.selected = true; s.add(o); }); openModal('editVoteModal'); };

    // SweetAlert Actions
    window.deleteDesign = (id) => { Swal.fire({ title:'‡∏•‡∏ö?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(async r => { if(r.isConfirmed) { await callApi('deleteDesign', {designId:id}); loadProducts(); } }); };
    window.deleteUser = (id) => { Swal.fire({ title:'‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(async r => { if(r.isConfirmed) { await callApi('deleteUser', {studentId:id}); loadUsers(); } }); };
    window.deleteAdmin = (u) => { Swal.fire({ title:'‡∏•‡∏ö Admin?', icon:'warning', showCancelButton:true, confirmButtonColor:'#d33' }).then(async r => { if(r.isConfirmed) { await callApi('deleteAdminAccount', {usernameToDelete:u}); loadAccounts(); } }); };

    // Chart
    let voteChartInstance = null;
    function displayVoteChart(votes) {
        const ctx = document.getElementById('voteChart')?.getContext('2d');
        if (!ctx) return;
        if (voteChartInstance) voteChartInstance.destroy();
        voteChartInstance = new Chart(ctx, { type: 'bar', data: { labels: votes.map(v => v[1]), datasets: [{ label: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', data: votes.map(v => v[2]), backgroundColor: 'rgba(99,102,241,0.7)' }] }, options: { responsive: true, maintainAspectRatio: false } });
    }
  </script>

</body>
</html>